<!DOCTYPE html>
<!--[if IE 8]><html class="no-js lt-ie9" lang="en" > <![endif]-->
<!--[if gt IE 8]><!--> <html class="no-js" lang="en" > <!--<![endif]-->
<head>
  <meta charset="utf-8">
  <meta http-equiv="X-UA-Compatible" content="IE=edge">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <meta name="description" content="None">
  
  <link rel="shortcut icon" href="../../img/favicon.ico">
  <title>Devops Management - GitOps with Argo CD - WebSphere Application Modernization</title>
  <link href='https://fonts.googleapis.com/css?family=Lato:400,700|Roboto+Slab:400,700|Inconsolata:400,700' rel='stylesheet' type='text/css'>

  <link rel="stylesheet" href="../../css/theme.css" type="text/css" />
  <link rel="stylesheet" href="../../css/theme_extra.css" type="text/css" />
  <link rel="stylesheet" href="//cdnjs.cloudflare.com/ajax/libs/highlight.js/9.12.0/styles/github.min.css">
  <link href="../../stylesheets/klp.css" rel="stylesheet">
  
  <script>
    // Current page data
    var mkdocs_page_name = "Devops Management - GitOps with Argo CD";
    var mkdocs_page_input_path = "devops-labs\\argocd\\README.md";
    var mkdocs_page_url = null;
  </script>
  
  <script src="../../js/jquery-2.1.1.min.js" defer></script>
  <script src="../../js/modernizr-2.8.3.min.js" defer></script>
  <script src="//cdnjs.cloudflare.com/ajax/libs/highlight.js/9.12.0/highlight.min.js"></script>
  <script>hljs.initHighlightingOnLoad();</script> 
  
</head>

<body class="wy-body-for-nav" role="document">

  <div class="wy-grid-for-nav">

    
    <nav data-toggle="wy-nav-shift" class="wy-nav-side stickynav">
      <div class="wy-side-nav-search">
        <a href="../.." class="icon icon-home"> WebSphere Application Modernization</a>
        <div role="search">
  <form id ="rtd-search-form" class="wy-form" action="../../search.html" method="get">
    <input type="text" name="q" placeholder="Search docs" title="Type search term here" />
  </form>
</div>
      </div>

      <div class="wy-menu wy-menu-vertical" data-spy="affix" role="navigation" aria-label="main navigation">
	<ul class="current">
	  
          
            <li class="toctree-l1">
		
    <a class="" href="../..">Home</a>
	    </li>
          
            <li class="toctree-l1">
		
    <a class="" href="../../environments-setup/">Reserve lab environment or workshop</a>
	    </li>
          
            <li class="toctree-l1">
		
    <a class="" href="../../basic-labs/">Basic Containerization & App Mod Tools Labs</a>
	    </li>
          
            <li class="toctree-l1">
		
    <a class="" href="../../appmod-labs/">App Modernization Labs</a>
	    </li>
          
            <li class="toctree-l1">
		
    <a class="" href="../">DevOps Labs</a>
	    </li>
          
            <li class="toctree-l1">
		
    <span class="caption-text">Resources</span>
    <ul class="subnav">
                <li class="">
                    
    <a class="" href="../../OpenshiftConcepts/">Openshift Concepts</a>
                </li>
                <li class="">
                    
    <a class="" href="../../WebSphereCloud/">Moving WebSphere applications to Cloud</a>
                </li>
                <li class="">
                    
    <a class="" href="../../resources/">Additional Resources</a>
                </li>
    </ul>
	    </li>
          
        </ul>
      </div>
      &nbsp;
    </nav>

    <section data-toggle="wy-nav-shift" class="wy-nav-content-wrap">

      
      <nav class="wy-nav-top" role="navigation" aria-label="top navigation">
        <i data-toggle="wy-nav-top" class="fa fa-bars"></i>
        <a href="../..">WebSphere Application Modernization</a>
      </nav>

      
      <div class="wy-nav-content">
        <div class="rst-content">
          <div role="navigation" aria-label="breadcrumbs navigation">
  <ul class="wy-breadcrumbs">
    <li><a href="../..">Docs</a> &raquo;</li>
    
      
    
    <li>Devops Management - GitOps with Argo CD</li>
    <li class="wy-breadcrumbs-aside">
      
    </li>
  </ul>
  <hr/>
</div>
          <div role="main">
            <div class="section">
              
                <h1 id="devops-management-gitops-with-argo-cd">Devops Management - GitOps with Argo CD</h1>
<h2 id="11-argo-cd-introduction">1.1 ARGO CD Introduction</h2>
<p>In this lab exercise, you will gain hands-on experience with Argo CD as a declarative GitOps continuous delivery tool for Kubernetes.</p>
<p>This guide will walk you through an example of how to build, deploy, and continuously manage an application following important GitOps practices.</p>
<p>We will be using the GitOps continuous delivery tool <strong>Argo CD</strong> in
this lab. This controller enables developers to automate application
deployment and lifecycle management.</p>
<p>Continuous Integration, Delivery, and Deployment are important devOps
practices. These processes are valuable and ensures that the software is
up to date timely.</p>
<ul>
<li>
<p><strong>Continuous Integration</strong> is an automation process which allows
    developers to integrate their work into a repository. When a
    developer pushes his work into the source code repository, it
    ensures that the software continues to work properly. It helps to
    enable collaborative development across the teams and also helps to
    identify the integration bugs sooner.</p>
</li>
<li>
<p><strong>Continuous Delivery</strong> comes after Continuous Integration. It
    prepares the code for release. It automates the steps that are
    needed to deploy a build.</p>
</li>
<li>
<p><strong>Continuous Deployment</strong> is the final step which succeeds
    Continuous Delivery. It automatically deploys the code whenever a
    code change is done. Entire process of deployment is automated.</p>
</li>
</ul>
<p><strong>GitOps</strong> in short is a set of practices to use Git pull requests to
manage infrastructure and application configurations. Git repository in
GitOps is considered the only source of truth and contains the entire
state of the system so that the trail of changes to the system state are
visible and auditable.</p>
<ul>
<li><strong>Traceability of changes</strong> in GitOps is no novelty in itself as this
    approach is almost universally employed for the application source
    code. However GitOps advocates applying the same principles
    (reviews, pull requests, tagging, etc) to infrastructure and
    application configuration so that teams can benefit from the same
    assurance as they do for the application source code.</li>
</ul>
<p><strong>Argo CD</strong> is a declarative, GitOps continuous delivery tool for
Kubernetes. Applications, application definitions, configurations, and
environments should be declarative and version controlled. Also
application deployment and lifecycle management should be automated,
auditable, and easy to understand. All this can be done using Argo.</p>
<p>Check these guides out if you want to know more about Argo - <a href="https://argoproj.github.io/argo-cd/">Argo CD -
Declarative GitOps CD for
Kubernetes</a>.</p>
<p>You can read more about Argo CD here:
<a href="https://argoproj.github.io/argo-cd/">https://argoproj.github.io/argo-cd/</a></p>
<p><strong>Argo CD architecture diagram</strong></p>
<p>The Argo CD component are described below the diagram.</p>
<p><img alt="" src="images/media/image1.png" /></p>
<h2 id="argo-cd-components"><strong>Argo CD Components</strong></h2>
<p><strong>API Server</strong></p>
<p>The API server is a gRPC/REST server which exposes the API consumed by
the Web UI, CLI, and CI/CD systems. It has the following
responsibilities:</p>
<ul>
<li>
<p>application management and status reporting</p>
</li>
<li>
<p>invoking of application operations (e.g. sync, rollback,
    user-defined actions)</p>
</li>
<li>
<p>repository and cluster credential management (stored as K8s secrets)</p>
</li>
<li>
<p>authentication and auth delegation to external identity providers</p>
</li>
<li>
<p>RBAC enforcement</p>
</li>
<li>
<p>listener/forwarder for Git webhook events</p>
</li>
</ul>
<p><strong>Repository Server</strong></p>
<p>The repository server is an internal service which maintains a local
cache of the Git repository holding the application manifests. It is
responsible for generating and returning the Kubernetes manifests when
provided the following inputs:</p>
<ul>
<li>
<p>repository URL</p>
</li>
<li>
<p>revision (commit, tag, branch)</p>
</li>
<li>
<p>application path</p>
</li>
<li>
<p>template specific settings: parameters, helm values.yaml, and more</p>
</li>
</ul>
<p><strong>Application Controller</strong></p>
<p>The application controller is a Kubernetes controller which continuously
monitors running applications and compares the current, live state
against the desired target state (as specified in the repo). It detects
OutOfSync application state and optionally takes corrective action. It
is responsible for invoking any user-defined hooks for lifecycle events
(PreSync, Sync, PostSync)</p>
<h2 id="13-what-exactly-are-we-building-here">1.3 What exactly are we building here?</h2>
<p>This Argo CD lab complements the OpenShift Pipelines lab that is
included in this workshop.</p>
<p>In the OpenShift pipelines lab, you used Tekton tasks and pipelines to
build and deploy the sample application to a “<strong>dev</strong>” namespace in an
OpenShift Cluster.</p>
<p>OpenShift pipelines (Tekton) allow for orchestration of tasks to be
executed as part of the continuous Integration (CI) Devops lifecycle.
While the pipeline used in this workshop is simple, and only performs
basic build and deploy tasks, it is common for pipelines to include
tasks that scan images for vulnerabilities, validate security policies,
run tests, perform additional validation, deploy to a DEV, or TEST
environment, and run custom tasks based on corporate requirements or
industry compliance.</p>
<p>For those reasons, OpenShift Pipelines (Tekton) shines when it comes to
executing continuous integration (CI) of the development lifecycle.</p>
<p>However, Argo CD is uniquely capable as a continuous delivery (CD)
solution for automating deployments of applications to specified
environments, tracking and synching the deployments, checking the status
of the deployments, and automated drift detection and visualization.</p>
<p>In this lab, you will see how Argo CD complements OpenShift Pipelines to
provide automated deployments to additional Kubernetes environments,
such as STAGING, or PROD.</p>
<p><strong>The overall Devops use case scenario in this workshop is:</strong></p>
<ul>
<li>
<p>Use <strong>OpenShift Pipelines</strong> for continuous integration (CI) in the
    application development lifecycle, which builds the application
    image, pushes to an image repository, and deploys the application to
    the DEV environment in OpenShift.</p>
</li>
<li>
<p>Use <strong>Argo CD</strong> for continuous deployment (CD) of the application,
    promoting the application to additional shared environments for
    testing or production.</p>
</li>
</ul>
<p>In this lab, you will:</p>
<ol>
<li>
<p>Clone the application's Git repo locally.</p>
</li>
<li>
<p>Build a Docker image for the application and push it to an OpenShift
    image registry.</p>
</li>
<li>
<p>Deploy the application with Argo CD and synch it to its Git repo</p>
</li>
<li>
<p>Push locally-made changes to the Git repo and view how Argo CD
    automatically synchronizes environment to match the desired state
    that is in the Git Repo, which is the system of truth for this
    GitOps solution.</p>
</li>
</ol>
<h1 id="14-lab-tasks">1.4 Lab Tasks</h1>
<h2 id="141-lets-get-started"><strong>1.4.1 Let’s get started</strong></h2>
<p>First, launch the lab environment and login to the VM.</p>
<ol>
<li>
<p>If the VM is not already started, start it by clicking the Play
    button.</p>
<p><img alt="Graphical user interface, application Description automatically
generated" src="images/media/image2.png" /></p>
<p><br/></p>
</li>
<li>
<p>After the VM is running (this may take several minutes), click the
    <strong>desktop</strong> VM to access it.</p>
<p><img alt="Graphical user interface, application Description automatically
generated" src="images/media/image3.png" /></p>
<p><br/></p>
</li>
<li>
<p>Login with the <strong>ibmuser</strong> user using the password <strong>engageibm</strong>.</p>
<p><img alt="Graphical user interface, application Description automatically
generated" src="images/media/image4.png" /></p>
<p><br/></p>
</li>
<li>
<p>Resize the Skytap environment window for a larger viewing area while
    doing the lab. From the Skytap menu bar, click on the <strong>Fit to
    Size</strong> icon. This will enlarge the viewing area to fit the size of
    your browser window.</p>
<p><img alt="A screenshot of a computer Description automatically generated
with medium confidence" src="images/media/image5.png" /></p>
<p><br/></p>
</li>
<li>
<p>Open a new Firefox browser window from the VM desktop.</p>
<p><img alt="Graphical user interface Description automatically generated with
medium confidence" src="images/media/image6.png" /></p>
<p><br/></p>
</li>
</ol>
<h2 id="142-clone-the-git-repository-used-for-this-lab-from-gitlab"><strong>1.4.2 Clone the Git repository used for this lab from GitLab</strong></h2>
<p>All of the files and artifacts required for this lab are available in a
public GitHub repository. You need to clone the GitHub repository to a
local repo on VM used in the lab environment.</p>
<table>
<tbody>
<tr class="odd">
<td><img src="./images/media/image7.png" style="width:2.47917in;height:2.47917in" alt="sign-info" /></td>
<td><p>You will be using a local installation of <strong>GitLab</strong> on the VM as the local repository.</p>
<p>Argo CD follows the <strong>GitOps</strong> pattern of using <strong>Git repositories</strong> as the source of truth for defining the desired application state. In order to execute this lab, a GitHub or GitLab account is required. Therefore, to eliminate the requirement of your own personal GitHub account, we installed GitLab locally, and provide a GitLab account for you.</p></td>
</tr>
</tbody>
</table>

<ol>
<li>
<p>Launch the GitLab UI and login</p>
<p>a.  Open a <strong>Firefox</strong> browser window on the Desktop VM</p>
<p>b.  Open GitLab from the <strong>GitLab</strong> bookmark menu.</p>
<p>c.  This will prompt you to login. Login with username
    <strong>gitlabUser@mail.com</strong> and password <strong>passw0rd</strong>. Then, click
    <strong>Sign in</strong>.</p>
<p><img alt="" src="images/media/image8.png" /></p>
<!-- end list -->

</li>
<li>
<p>Import the <strong>openshift-workshop-was</strong> GitHub repository to GitLab on
    the local VM.</p>
<p>a.  From the GitLab UI, click <strong>Create a project</strong> link.</p>
<p>b.  Click on <strong>Import project</strong> to import this lab's repository from
    GitHub</p>
<p><img alt="" src="images/media/image9.png" /></p>
<p>c.  Under the import project from section, select the <strong>Repo by
    URL</strong> option</p>
<p><img alt="" src="images/media/image10.png" /></p>
<p>d.  In the resulting page, enter the following values for each
    field:</p>
<!-- end list -->

<ul>
<li>
<blockquote>
<p>Git repository URL:
  <strong>https://github.com/IBMTechSales/openshift-workshop-was.git</strong></p>
<p>This is the GitHub repository that contains the resources for this lab</p>
</blockquote>
</li>
<li>
<blockquote>
<p>Project name: <strong>openshift-workshop-was</strong></p>
<p>This is the GitHub repository that contains the resources for this lab</p>
</blockquote>
</li>
<li>
<blockquote>
<p>Project slug: <strong>openshift-workshop-was</strong></p>
</blockquote>
</li>
<li>
<blockquote>
<p>Visibility Level: <strong>Public</strong> (Select the radio button for “Public” visibility</p>
</blockquote>
</li>
<li>
<blockquote>
<p>Leave the <strong>Username</strong> and <strong>Password</strong> filed blank. You do not need credentials to access the public repository</p>
</blockquote>
</li>
</ul>
<p>The form should look like the following filled-out form. When
finished.</p>
<p><img alt="" src="images/media/image11.png" /></p>
<p><img alt="" src="images/media/image12.png" /></p>
<p>e.  Click the <strong>Create project</strong> button, which will create the new
    project and populate it with the imported files from the
    specified GitHub repository.</p>
<!-- end list -->

<p><br/></p>
</li>
<li>
<p>Clone the <strong>openshift-workshop-was</strong> GitLab repository onto the VM.</p>
<p>a. From GitLab UI, click on the <strong>Clone</strong> button from the page displaying the imported repository.</p>
<p>b. Under the <strong>Clone with HTTP</strong> section, click on the <strong>copy icon</strong> to copy the repo link to clipboard.</p>
<p><img alt="" src="images/media/image13.png" /></p>
<p>c. From the Desktop VM, open a new <strong>terminal window</strong>.</p>
<p><img alt="A picture containing text Description automatically
generated" src="images/media/image14.png" /></p>
<p>d. From the terminal window, ensure that you are in the home directory of the user "ibmuser"</p>
<pre><code>cd /home/ibmuser
</code></pre>
<p>e.  Run the following command to clone the repo with the GitHub using the URL you copied in the previous step. Enter username <strong>gitlabUser</strong> and password <strong>passw0rd</strong> if prompted to login.</p>
<pre><code>git clone http://gitlab.demo.ibmdte.net/gitlabUser/openshift-workshop-was.git
</code></pre>
<p><img alt="" src="images/outpics/01.png" /></p>
<p>These commands above clone the repo <strong>openshift-workshop-was</strong> to
the local directory under <strong>/home/ibmuser/openshift-workshop-was</strong>
directory.</p>
<!-- end list -->

<p><br/></p>
</li>
<li>
<p>Change to the directory in which this lab is located.</p>
<pre><code>cd  /home/ibmuser/openshift-workshop-was/labs/Openshift/DevopsManagement
</code></pre>
<p><img alt="" src="images/outpics/02.png" /></p>
</li>
<li>
<p>List the directory contents using the <code>ls</code> command</p>
<p>You will find the following key resources:</p>
<ul>
<li>
<blockquote>
<p><strong>Dockerfile</strong> - Used to build the application on the Liberty
runtime</p>
</blockquote>
</li>
<li>
<blockquote>
<p><strong>Dockerfile1</strong> - Used to build a new image for the application</p>
</blockquote>
</li>
<li>
<blockquote>
<p><strong>app</strong> - The Customer Order Services application</p>
</blockquote>
</li>
<li>
<blockquote>
<p><strong>deploy</strong> - Used to handle deployment of the application</p>
</blockquote>
</li>
<li>
<blockquote>
<p><strong>argocd-basic.yaml</strong> - Used to create new Argo CD resource for
operator</p>
</blockquote>
</li>
</ul>
<p><img alt="" src="images/outpics/03.png" /></p>
<p><br/></p>
</li>
</ol>
<h2 id="143-login-to-openshift-and-create-a-new-project-for-this-lab"><strong>1.4.3 Login to OpenShift and create a new project for this lab</strong></h2>
<ol>
<li>
<p>Type <code>oc login</code> to login to OpenShift. Use <strong>ibmadmin</strong> for the
    username and <strong>engageibm</strong> for the password.</p>
<p><img alt="" src="images/outpics/04.png" /></p>
<p><br/></p>
</li>
<li>
<p>Type <code>oc new-project staging</code> which will create a new project named
    <strong>staging</strong>, and switch your context to that project</p>
<p><table>
<tbody>
<tr class="odd">
<td><img src="./images/media/image7.png" style="width:1.63542in;height:1.63542in" alt="sign-info" /></td>
<td><p><strong>Note:</strong> Ensure you create the new project with the name “<strong>staging</strong>”.</p>
<p>Otherwise, you will be required to review and modify all YAML files that reference this OpenShift project (Namespace), prior to running the YAML files to create the pipeline resources.</p></td>
</tr>
</tbody>
</table></p>
<p><img alt="" src="images/outpics/05.png" /></p>
<p><br/></p>
</li>
</ol>
<h2 id="144-build-the-docker-image-push-the-image-to-openshift-image-registry"><strong>1.4.4 Build the Docker image &amp; push the image to OpenShift Image Registry</strong></h2>
<p>You will now build the “<strong>cos</strong>” application container image using the
Dockerfile that has been provided in the lab resources. This is the same
application used in all labs in this workshop. </p>
<p>The <strong>cos</strong> application is a Java EE Application and runs on Open Liberty in this lab.</p>
<ol>
<li>
<p>Run the following command to start building the image. Make sure to
    copy the entire command including the <strong>"."</strong> at the end (indicates
    the location as current directory). The image may a few minutes to complete building.</p>
<pre><code>docker build --tag default-route-openshift-image-registry.apps.demo.ibmdte.net/staging/cos  -f Dockerfile .
</code></pre>
<p><img alt="" src="images/outpics/06.png" /></p>
<p>About the docker build command:</p>
<ul>
<li>
<p>Instructs Docker to build the image following the instructions in
the <strong>Dockerfile</strong> in the current directory</p>
</li>
<li>
<p>Specifies a name to tag the built image after <strong>--tag</strong></p>
</li>
<li>
<p>Includes the value <strong>default-route-openshift-image-registry.apps.demo.ibmdte.net</strong> as
the default address of the internal image registry provided by
OpenShift</p>
</li>
</ul>
<p><br/></p>
</li>
<li>
<p>Validate that the image is in the repository by running the command:</p>
<pre><code>docker images
</code></pre>
<p><img alt="" src="images/outpics/07.png" /></p>
<p>Notice that the <strong>openliberty/open-liberty</strong> base image is also
listed. It was pulled during the first step of building the
application image.</p>
<p><br/></p>
</li>
<li>
<p>Login to the <strong>internal OpenShift image registry</strong>, where you will push
    the docker image.</p>
<pre><code>docker login -u openshift -p $(oc whoami -t) default-route-openshift-image-registry.apps.demo.ibmdte.net
</code></pre>
<p><img alt="" src="images/outpics/08.png" /></p>
<p><br/></p>
</li>
<li>
<p>Push the image to OpenShift's internal image registry. (This could
    take a few minutes).</p>
<pre><code>docker push default-route-openshift-image-registry.apps.demo.ibmdte.net/staging/cos
</code></pre>
<p><img alt="" src="images/outpics/09.png" /></p>
<p><br/></p>
</li>
<li>
<p>Verify that the image is in the image registry.</p>
<pre><code>oc get images | grep staging/cos
</code></pre>
<p><img alt="" src="images/outpics/10.png" /></p>
<p>This command will get all images in the registry, but we can use <strong>grep</strong> to filter through the results to get only the image you pushed.</p>
</li>
</ol>
<blockquote>
<p>The hash of the image is stored alongside the SHA-256 value. Take note
of this value so that you can identify the original image used to
deploy the application. </p>
<p>In this example, the hash value is <strong>531aabe0aa2a4d542b311cab1cdc874ca3cfbe09ecbc5c39d9f3c6d810c7a4c2</strong> but yours will be different.</p>
</blockquote>
<p><br/></p>
<h2 id="145-get-argo-cd-login-info-from-the-ocp-cluster"><strong>1.4.5 Get Argo CD login info from the OCP cluster</strong></h2>
<p>In this lab environment, Argo CD has already been installed to the OCP
cluster using the Argo CD OpenShift operator. Additionally, all
configurations have already been made so that Argo CD is ready for
deployment and management of our application. </p>
<h4 id="-">----------------------------------------------------------------------------------------</h4>
<p>This setup involved the following, and is here for your reference:</p>
<p><strong>Step 1.</strong>  Deployed a basic Argo CD cluster by creating a new Argo CD resource
    in the namespace (<strong>argocd</strong>) where the operator is installed</p>
<blockquote>
<ul>
<li><strong>argocd-basic.yaml</strong> contains the YAML for this resource. You
        can review the contents of this file with the following command
        (make sure you are in the <strong>DevopsManagement</strong> directory):</li>
</ul>
</blockquote>
<pre><code>   cat argocd-basic.yaml
</code></pre>
<p><strong>Step 2.</strong>  Enabled full cluster admin access to
    <strong>example-argocd-argocd-application-controller</strong> service account
    (this service account was automatically created by the Argo CD
    resource in the previous step)</p>
<p>You can learn more about the install and setup of the Argo CD operator
by reading its full documentation here:
<a href="https://argocd-operator.readthedocs.io/en/latest/usage/basics/">https://argocd-operator.readthedocs.io/en/latest/usage/basics/</a></p>
<h4 id="-_1">----------------------------------------------------------------------------------------</h4>
<p>In order to access the Argo CD UI, you will first need to obtain login
credentials information from the OCP cluster. The credentials are stored
in a Kubernetes secret in the argocd namespace.</p>
<ol>
<li>
<p>Get Argo CD password info.</p>
<p>a.  Return to your terminal window.</p>
<p>b.  Run the following commands to export the Argo CD admin account's
    password and display it. </p>
<pre><code>  export ARGOCD\_PASSWORD=$(oc -n argocd get secret example-argocd-cluster -o jsonpath='{.data.admin\\.password}' | base64 -d)

  echo $ARGOCD\_PASSWORD
</code></pre>
<p><img alt="" src="images/outpics/11.png" /></p>
<blockquote>
<ul>
<li>
<p>The Argo CD operator is installed in namespace <strong>argocd</strong> as
    specified with the <strong>-n</strong> option.</p>
</li>
<li>
<p>The <strong>example-argocd-cluster</strong> secret was automatically created
    by the Argo CD resource and contains login credentials.</p>
</li>
</ul>
</blockquote>
<p>c. Copy the <strong>password</strong> value outputted by the <strong>echo command</strong> (you will need this later for login to the UI)</p>
<p><br/></p>
</li>
</ol>
<h2 id="146-access-the-argo-cd-ui-and-login"><strong>1.4.6 Access the Argo CD UI and login</strong></h2>
<p>The Argo CD server component exposes the API and UI which is then made
accessible by a service and OpenShift <strong>route</strong> created by the operator.
This allows you to access the UI through your local VM.</p>
<ol>
<li>
<p>Get the Argo CD route</p>
<pre><code>oc -n argocd get routes
</code></pre>
<p><img alt="" src="images/outpics/12.png" /></p>
<p><br/>   </p>
</li>
<li>
<p>Based on the Argo CD the route information, the Argo CD UI URL is:</p>
<p><a href="https://example-argocd-server-argocd.apps.demo.ibmdte.net">https://example-argocd-server-argocd.apps.demo.ibmdte.net</a></p>
<p>a.  Open this URL in a new tab from your Firefox browser in the desktop VM</p>
<p><br/></p>
</li>
<li>
<p>A login page will be displayed. Login with username <strong>admin</strong> and
    enter the Argo CD password value we copied previously as the
    password. Click <strong>Sign In</strong>.</p>
<p><img alt="Graphical user interface Description automatically generated with
medium confidence" src="images/media/image15.png" /></p>
<p><br/></p>
</li>
</ol>
<h2 id="147-create-an-argo-cd-project-in-the-ui"><strong>1.4.7 Create an Argo CD project in the UI</strong></h2>
<p>Now that the UI is accessible and ready to go, we can create a new Argo
CD project <strong>staging</strong> to host the Argo CD application.</p>
<ol>
<li>
<p>Create a new Argo Cd project</p>
<p>a.  From the Argo CD UI home page, navigate to the <strong>Settings</strong> page
    by clicking on the gears icon from the menu on the left. Then,
    click on <strong>Projects.</strong></p>
<p><img alt="" src="images/media/image16.png" /></p>
<p>b.  Click on the <strong>New Project</strong> button in the upper left corner of the
page.</p>
<p><img alt="" src="images/media/image17.png" /></p>
<p>c.  In the window that pop ups from the right, enter Name <strong>staging</strong>
and Description <strong>staging</strong>. Then, click on <strong>Create</strong>.</p>
<p><img alt="" src="images/media/image18.png" /></p>
<p>d.  The <strong>staging</strong> project summary details page is now shown.</p>
<blockquote>
<p>A <strong>Project</strong> in Argo CD provide a logical grouping of applications, which is useful when Argo CD is used by multiple teams. Projects provide the following features:</p>
<ul>
<li>
<p><strong>Source Repositories:</strong> Reference to the repositories that
applications within the project can pull manifests from</p>
</li>
<li>
<p><strong>Destinations:</strong> Reference to clusters and namespaces that
applications within the project can deploy into</p>
</li>
<li>
<p><strong>Cluster Resources</strong>: The Kubernetes cluster resources that are
allowed or denied to be deployed</p>
</li>
</ul>
</blockquote>
</li>
<li>
<p>Edit the <strong>SOURCE REPOSITORY</strong> properties of the staging project to
    define source repositories</p>
<p>a.  In the <strong>Source Repositories</strong> section, click on the <strong>Edit</strong>
    button</p>
<p><img alt="" src="images/media/image19.png" /></p>
<p>b.  Click on <strong>Add Source</strong></p>
<p><img alt="" src="images/media/image20.png" /></p>
<p>c.  This will show an asterisk (*). Click on the <strong>Save button.</strong></p>
<blockquote>
<ul>
<li>Adding this source repository will allow our <strong>staging</strong> project to
retrieve data from any Git repository where our application lies.</li>
</ul>
</blockquote>
<p><img alt="" src="images/media/image21.png" /></p>
<p><br/></p>
</li>
<li>
<p>Edit the <strong>DESTINATIONS</strong> properties of the staging project to
    define destination cluster / namespaces that the projects
    applications can be deployed.</p>
<p>a.  In the <strong>Source Repositories</strong> section, click on the <strong>Edit</strong>
    button</p>
<p><img alt="" src="images/media/image22.png" /></p>
<p>b.  Click on <strong>Add Destination</strong></p>
<p><img alt="" src="images/media/image23.png" /></p>
<p>c.  This will show an asterisk (*). Click on the <strong>Save button.</strong></p>
<blockquote>
<ul>
<li>Adding this destination allows the project to deploy our application
to a cluster and namespace.</li>
</ul>
</blockquote>
<p><img alt="" src="images/media/image21.png" /></p>
<p><br/></p>
</li>
<li>
<p>Edit the <strong>CLUSTER RESOURCE ALLOW LIST</strong> properties of the staging
    project to define Kubernetes resources that are allowed to be
    deployed in the cluster</p>
<p>a.  In the <strong>CLUSTER RESOURCE ALLOW LIST</strong> section, click on the
    <strong>Edit</strong> button</p>
<p><img alt="" src="images/media/image24.png" /></p>
<p>b.  Click on <strong>Add Resource</strong> under the <strong>CLUSTER RESOURCE ALLOW
    LIST</strong> section</p>
<p><img alt="" src="images/media/image25.png" /></p>
<p>c.  This will show an asterisk (*). Click on the <strong>Save button.</strong></p>
<blockquote>
<ul>
<li>Adding this resource allow list source permits deployment of
Kubernetes API groups and kinds to the Kubernetes cluster.</li>
</ul>
</blockquote>
<p><img alt="" src="images/media/image26.png" /></p>
<p><br/></p>
</li>
<li>
<p>When you are done, the project page should look like the following:</p>
<p><img alt="" src="images/media/image27.png" /></p>
<p>The staging project is now configured to permit deployment of
applications to the OpenShift Cluster. You likely noticed that we
simply used wildcards to specify the permitted source repos,
destinations, and cluster resources.</p>
<p>In a real environment, you would take special care to restrict these
permissions to known trusted resources and limit the destinations
and resources based on the business and application requirements.</p>
<p><br/></p>
</li>
</ol>
<h2 id="148-deploy-application-through-argo-cd-ui"><strong>1.4.8 Deploy application through Argo CD UI</strong></h2>
<p>Now that the project has been properly set up, you are ready to deploy
the Customer Order Services application using Argo CD.</p>
<ol>
<li>
<p>Navigate to the <strong>Applications</strong> tab in the Argo CD UI by clicking
    on the top icon in the left menu. This will bring you to a page
    displaying all applications currently being run by Argo CD.</p>
<p><img alt="Graphical user interface, application, Teams Description automatically generated" src="images/media/image28.png" /></p>
<p><br/></p>
</li>
<li>
<p>Click on <strong>New App</strong> in the upper left of the page to create a new
    deployment of our application.</p>
<p><img alt="" src="images/media/image29.png" /></p>
<p><br/></p>
</li>
<li>
<p>Return to the GitLab page displaying the <strong>openshift-workshop-was</strong>
    project. Click on <strong>Clone</strong> and copy the link under the <strong>Clone with
    HTTP</strong> section. You will need this URL to create the application in
    the Argo CD UI.</p>
<p><img alt="Graphical user interface, text, application, email Description automatically generated" src="images/media/image30.png" /></p>
<p><br/></p>
</li>
<li>
<p>Enter the following details to create the application. Click
    <strong>Create</strong> to finish, after completing the form.</p>
<blockquote>
<p><strong>GENERAL settings:</strong></p>
<ul>
<li>
<p>Application Name: <code>cos</code></p>
</li>
<li>
<p>Project: <code>staging</code></p>
</li>
<li>
<p>Sync Policy: <code>Manual</code></p>
</li>
</ul>
</blockquote>
<p><img alt="Graphical user interface, text, application Description automatically generated" src="images/media/image31.png" /></p>
<blockquote>
<p><strong>SOURCE settings:</strong></p>
<ul>
<li>Repository URL: <code>http://gitlab.demo.ibmdte.net/gitlabUser/openshift-workshop-was.git</code></li>
</ul>
<blockquote>
<p><strong>Note:</strong> This is the URL that you copied from GitLab in the previous step.</p>
</blockquote>
<ul>
<li>
<p>Revision: <code>HEAD</code></p>
</li>
<li>
<p>Path: <code>labs/Openshift/DevopsManagement/deploy/overlays/staging</code></p>
</li>
</ul>
<blockquote>
<p><strong>Note:</strong> This is the path within the repository to the YAML files that handle the application's deployment for the staging project.</p>
</blockquote>
</blockquote>
<p><img alt="Graphical user interface, application Description automatically generated" src="images/media/image32.png" /></p>
<blockquote>
<p><strong>DESTINATION settings</strong></p>
<ul>
<li>
<p>Cluster: <code>https://kubernetes.default.svc</code></p>
</li>
<li>
<p>Namespace: <code>staging</code></p>
</li>
</ul>
<blockquote>
<p><strong>Note</strong>: This corresponds to the new <strong>staging</strong> OpenShift project we created previously.</p>
</blockquote>
</blockquote>
<p><img alt="Graphical user interface, application, Teams Description automatically generated" src="images/media/image33.png" /></p>
<p><br/></p>
</li>
<li>
<p>This new application will now be listed among available apps, but it
    will initially be out of sync. Because we set a <strong>Manual</strong> sync
    policy, you will need to sync it for deployment.</p>
<p><img alt="" src="images/media/image34.png" /></p>
<p><br/></p>
</li>
<li>
<p>In order to sync the application with your Git repository, click on
    <strong>Sync</strong> within the <strong>cos</strong> application's panel and then click
    <strong>Synchronize</strong> in the resulting pop-up window.</p>
<p><img alt="Graphical user interface, text, application Description automatically generated" src="images/media/image35.png" /></p>
<p>Do not check off any of the various options available for you (prune,
dry run, etc.) but a brief description of what each of these do is
given below for a better understanding of how Argo CD works.</p>
<blockquote>
<ul>
<li>
<p><strong>Prune:</strong> allow unexpected resources to be automatically deleted</p>
</li>
<li>
<p><strong>Dry Run</strong>: preview of changes without affecting the
cluster yet</p>
</li>
<li>
<p><strong>Apply Only</strong>: only run the apply for application resources</p>
</li>
<li>
<p><strong>Force</strong>: force sync the application</p>
</li>
</ul>
</blockquote>
</li>
<li>
<p>Once the sync is complete, Argo CD will begin the deployment process
    of the application. When it is done, the STATUS should be
    <strong>Healthy</strong> and <strong>Synched</strong> as illustrated below</p>
<p><img alt="Graphical user interface, application Description automatically generated" src="images/media/image36.png" /></p>
<p><br/></p>
</li>
<li>
<p>Click on the <strong>cos</strong> application to view additional details. Hover
    over the <strong>cos</strong> pod block to see the image used for deployment. We
    know this is the same image as the one we built before because of
    the corresponding hash value.</p>
<p><img alt="Graphical user interface, text Description automatically generated" src="images/media/image37.png" /></p>
<p><br/></p>
</li>
</ol>
<h2 id="149-verify-the-applications-deployment"><strong>1.4.9 Verify the application's deployment</strong></h2>
<p>You will now access the Customer Order Services application to verify
that it has been correctly deployed by Argo CD.</p>
<ol>
<li>
<p>Return to your Terminal window and run the following command to list
    the <strong>cos-staging</strong> route in our <strong>staging</strong> namespace.</p>
<pre><code>oc get route -n staging
</code></pre>
<p><img alt="" src="images/outpics/13.png" />    </p>
<p><br/></p>
</li>
<li>
<p>Run the following command to get the URL of your application, from
    the route</p>
<pre><code>echo http://$(oc get route cos --template='{{ .spec.host &gt; }}')/CustomerOrderServicesWeb
</code></pre>
<p><img alt="" src="images/outpics/14.png" /></p>
<p>The resulting URL is where we can access our deployed application.</p>
<p><br/></p>
</li>
<li>
<p>Return to your <strong>Firefox</strong> browser window, open a new Browser tab; then
    open the URL outputted by the previous command in a new tab.</p>
<pre><code>http://cos-staging.apps.demo.ibmdte.net/CustomerOrderServicesWeb
</code></pre>
<p><br/></p>
</li>
<li>
<p>You will be prompted to login in order to access the application.
    Enter username <strong>skywalker</strong> and password <strong>force</strong>. Then, click
    <strong>OK</strong>.</p>
<p><img alt="Graphical user interface, application Description automatically generated" src="images/media/image38.png" /></p>
<p><br/></p>
</li>
<li>
<p>After login, the page titled <strong>Electronic and Movie Depot</strong> will be
    displayed. Drag and drop a few movies into the shopping cart to
    ensure that the application is functioning correctly.</p>
<p><img alt="Graphical user interface, application, Teams Description automatically generated" src="images/media/image39.png" /></p>
<p><br/></p>
</li>
<li>
<p>As items are added, they'll be shown under <strong>Current Shopping Cart</strong>
    (on the upper right) with the updated <strong>Order Total</strong>.</p>
</li>
</ol>
<p><img alt="Graphical user interface, application, Teams Description automatically generated" src="images/media/image40.png" /></p>
<p><br/></p>
<h2 id="1410-update-the-deployment-through-git-and-view-changes-in-argo-cd"><strong>1.4.10 Update the deployment through Git and view changes in Argo CD</strong></h2>
<p>The application is now synced with your GitHub repository by Argo CD,
making it simple to apply any latest changes and update deployment. You
will see how this works by pushing changes to your GitHub repo and
checking to see how this is reflected in Argo CD. Let's simulate an
updated application version release by building and tagging a new image.</p>
<ol>
<li>
<p>Build a new image using <strong>Dockerfile1</strong> instead of <strong>Dockerfile</strong> in
    the current directory and tag it with <strong>v2.0</strong> to indicate a new
    version of the image:</p>
<pre><code>docker build --tag default-route-openshift-image-registry.apps.demo.ibmdte.net/staging/cos:v2.0 -f Dockerfile1 .
</code></pre>
<p><img alt="" src="images/outpics/15.png" /></p>
<p><br/></p>
</li>
<li>
<p>Verify that a new Docker image has been built with the updated <strong>v2.0</strong> tag:</p>
<pre><code>docker images
</code></pre>
<p><img alt="" src="images/outpics/16.png" /></p>
<p><br/>   </p>
</li>
<li>
<p>Push this new image (v2.0) to OpenShift's internal image registry.</p>
<pre><code>docker push default-route-openshift-image-registry.apps.demo.ibmdte.net/staging/cos:v2.0
</code></pre>
<p><img alt="" src="images/outpics/17.png" />    </p>
<p>Take note of your new image's hash value (shown alongside sha256) so
that you can identify the updated image in the Argo CD UI. </p>
<p>In this example, the image's hash value is
<strong>2df354e72b89c7726d0e707cfd9e98a91f207bd3b9d048d3b81ce9a89918883f</strong> but
yours will be different.</p>
<p><br/></p>
</li>
<li>
<p>Update the application's deployment in your GitHub repository so
    that the newly created version of the image is used instead and push
    these changes.</p>
<p>You will do this by updating the Kustomize <strong>staging</strong> overlay, to
point to v2.0 of the application for deployment to the staging
environment.</p>
<p>a.  Open the <strong>applicationImage.yaml</strong> file in an editor:</p>
<pre><code>  gedit deploy/overlays/staging/applicationImage.yaml
</code></pre>
<p><img alt="Graphical user interface, text, application, email Description automatically generated" src="images/media/image41.png" /></p>
<p>b.  Change the value for <strong>applicationImage</strong> so that the new image
    with <strong>v2.0</strong> tag is used. The file should look like the image
    above. Then, click <strong>Save</strong>.</p>
<p>c.  Return to your Terminal window and run the following commands to
    push these changes to your GitLab repository. Enter username
    <strong>gitlabUser</strong> and password <strong>passw0rd</strong> when prompted to login.</p>
<pre><code>git add .

git commit -m "new image version"

git push -u origin master
</code></pre>
<p><img alt="" src="images/outpics/18.png" />    </p>
<p><br/> </p>
</li>
<li>
<p>Check that the updated version of the image has been applied to the
    application in Argo CD.</p>
<p>a.  Return to the Argo CD UI from your Firefox web browser and open
    the <strong>cos</strong> application details page if not open already.</p>
<p>b.  Upon <strong>refresh</strong> of the page, the application's status is now
    shown as <strong>OutOfSync</strong> because of the changes you made to the
    GitLab repo.</p>
<p><img alt="Graphical user interface Description automatically generated" src="images/media/image42.png" /></p>
<p>c.  Because we set up manual sync for this application, you will
    need to resync it to see applied changes. To do so, click on the
    <strong>Sync</strong> button and then <strong>Synchronize.</strong></p>
<p><img alt="Graphical user interface, application Description automatically generated" src="images/media/image43.png" /></p>
<p>d.  Once the <strong>manual synch</strong> is complete, hover your cursor over
    the new pod with name starting with <strong>cos</strong> to view additional
    details. </p>
<blockquote>
<p>Notice how the value for image now corresponds to the new hash of the updated image version that you took note of earlier.</p>
</blockquote>
<p><img alt="Graphical user interface, text Description automatically generated" src="images/media/image44.png" /></p>
<p>As you can see, the new image version has been updated by Argo CD! Version <strong>2.0</strong> of the cos application was automatically deployed to the staging environment.</p>
<p><br/></p>
</li>
</ol>
<h2 id="1411-using-the-argo-cd-cli"><strong>1.4.11 Using the Argo CD CLI</strong></h2>
<p>Argo CD also has a Command Line Interface, which has already been
installed on your environment. This allows you to perform important Argo
CD functions such as login, create projects, applications, and sync
applications through command line instead of the UI. Let's see some
examples of these functions:</p>
<ol>
<li>
<p>Login using the CLI</p>
<p>a.  Export the Argo CD admin account's password again for login.</p>
<pre><code>export ARGOCD_PASSWORD=$(oc -n argocd get secret example-argocd-cluster -o jsonpath='{.data.admin\.password}' | base64 -d)

echo $ARGOCD\_PASSWORD
</code></pre>
<p><img alt="" src="images/outpics/19.png" />    </p>
<p>b.  Enter the following command to login to the Argo CD server as
    the “<strong>admin</strong>” user. When asked if you want to proceed
    insecurely, type in <strong>y</strong> and press enter to continue.</p>
<pre><code>argocd login --username admin --password $ARGOCD_PASSWORD example-argocd-server-argocd.apps.demo.ibmdte.net
</code></pre>
<p><img alt="" src="images/outpics/20.png" />    </p>
<p><br/></p>
</li>
<li>
<p>List all Argo CD applications with the following command. You will
    see the <strong>cos</strong> application we just created listed along with some
    of its details.</p>
<pre><code>argocd app list
</code></pre>
<p><img alt="" src="images/outpics/21.png" />    </p>
<p><br/>       </p>
</li>
<li>
<p>You can view additional details of an application with the <strong>argocd
    app get</strong> command. Let's do this for our application <strong>cos</strong>.</p>
<pre><code>argocd app get cos
</code></pre>
<p><img alt="" src="images/outpics/22.png" />    </p>
<p><br/>       </p>
</li>
<li>
<p>You can also sync applications through the Argo CD CLI.</p>
<pre><code>argocd app sync cos
</code></pre>
<p><img alt="" src="images/outpics/23.png" />    </p>
<p><br/></p>
</li>
<li>
<p>Now, let's logout of Argo CD.</p>
<pre><code>argocd logout example-argocd-server-argocd.apps.demo.ibmdte.net
</code></pre>
<p><img alt="" src="images/outpics/24.png" />    </p>
<p><br/>   </p>
</li>
</ol>
<p>There are many other Argo CD CLI commands that can be run. For a
full list of these functions and further reading on the Argo CD
command line tool, you can take a look at:</p>
<p><a href="https://argoproj.github.io/argo-cd/user-guide/commands/argocd/">https://argoproj.github.io/argo-cd/user-guide/commands/argocd/</a></p>
<p><br/></p>
<h1 id="15-conclusion">1.5 Conclusion</h1>
<p>Congratulations! You have completed the lab and are on your way to
using Argo CD and GItHub for continuous integration, delivery and
deployment of your application with the RedHat OpenShift Container
Platform.</p>
<p>In this lab, you learned how to deploy and automate management of an
application using Argo CD following GitOps practices.</p>
<h2 id="end-of-lab-gitops-with-argo-cd">End of Lab: GitOps with Argo CD</h2>
<h4 id="-_2">----------------------------------------------------------------</h4>
<p><br/><br/></p>
<h1 id="appendix-skytap-tips-for-labs">Appendix: SkyTap Tips for labs</h1>
<h2 id="how-to-use-copy-paste-between-local-desktop-and-skytap-vm">How to use Copy / Paste between local desktop and Skytap VM</h2>
<p>Using copy / Paste capabilities between the lab document (PDF) on your local workstation to the VM is a good approach to more efficiently work through a lab, while reducing the typing errors that often occur when manually entering data.</p>
<ol>
<li>
<p>In SkyTap, you will find that any text copied to the clipboard on your local workstation is not available to be pasted into the VM on SkyTap. So how can you easily accomplish this?</p>
<p>a.  First copy the text you intend to paste, from the lab document, to the clipboard on your local workstation, as you always have (CTRL-C)</p>
<p>b.  Return to the SkyTap environment and click on the Clipboard at the top of the SkyTap session window.</p>
<p><img alt="" src="images/media/image45.png" /></p>
<p><br/></p>
<p>c.  Use <strong>CTRL-V</strong> to paste the content into the Copy/paste VM clipboard. Or use the <strong>paste</strong> menu item that is available in the dialog, when you right mouse click in the clipboard text area.</p>
<p><img alt="" src="images/media/image46.png" /></p>
<p><br/></p>
<p>d.  Once the text is pasted, just navigate away to the VM window where you want to paste the content. Then, use <strong>CTRL-C</strong>, or right mouse click &amp; us the <strong>paste menu item</strong> to paste the content.</p>
<p><img alt="" src="images/media/image47.png" /></p>
<p>e.  The text is pasted into the VM</p>
<p><img alt="" src="images/media/image48.png" /></p>
</li>
</ol>
<p><strong>Note:</strong> The very first time you do this, if the text does not paste, you may have to paste the contents into the Skytap clipboard twice. This is a known Skytap issue. It only happens on the 1<sup>st</sup> attempt to copy / paste into Skytap.</p>
              
            </div>
          </div>
          <footer>
  

  <hr/>

  <div role="contentinfo">
    <!-- Copyright etc -->
    
  </div>

  Built with <a href="http://www.mkdocs.org">MkDocs</a> using a <a href="https://github.com/snide/sphinx_rtd_theme">theme</a> provided by <a href="https://readthedocs.org">Read the Docs</a>.
</footer>
      
        </div>
      </div>

    </section>

  </div>

  <div class="rst-versions" role="note" style="cursor: pointer">
    <span class="rst-current-version" data-toggle="rst-current-version">
      
      
      
    </span>
</div>
    <script>var base_url = '../..';</script>
    <script src="../../js/theme.js" defer></script>
      <script src="../../search/main.js" defer></script>

</body>
</html>

<!--
MkDocs version : 1.0.4
Build Date UTC : 2021-09-08 12:54:32
-->
